$(document).on "turbolinks:load", ->
  class Notifications
    constructor: ->
      @notifications = $("[data-behavior='notifications']")
      @setup() if @notifications.length > 0

    setup: ->
      $("[data-behavior='read-notifications']").on "click", @readNotifications
      $.ajax(
        url: "/notifications.json"
        dataType: "JSON"
        method: "GET"
        success: @renderNotifications
      )

    readNotifications: (e) =>
      $.ajax(
        url: "/notifications/mark_as_read"
        dataType: "JSON"
        method: "POST"
        success: ->
          $("[data-behavior='unread-count']").text(0)
      )

    renderNotifications: (data) =>
      unread_count = 0
      unread = for d in data
                 if ! d.seen
                   unread_count += 1

      items = $.map data, (notification) ->
        "
        <div class='notifications-#{notification.seen}'>
        <a href='#{notification.redirect.path}'>
          <div class='left'>
            <div class='icon_notify'>
              <img class='nav-avatar' src='#{notification.user.image_url}'>
            </div>
            <p><strong>#{notification.user.slug}</strong> #{notification.action} #{notification.notifiable.type}<br>
              <time>#{notification.date}</time>
            </p>
          </div>
        </a>
        </div>
        "

      $("[data-behavior='unread-count']").text(unread_count)
      $("[data-behavior='notification-items']").html(items)
      if items.length > 0
        $("[data-behavior='notification-items']").append('<a href="/notifications/all" class="all-not-link" >Ver todas</a>')
      else
        $("[data-behavior='notification-items']").append('<div  class="all-not-link" >No hay nada para mostrar</div>')
  jQuery ->
    new Notifications
